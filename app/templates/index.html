<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- CSP is now handled by Flask -->
    <title>DNS By Eye</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='dns_by_eye_favicon.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .tree ul { list-style-type: none; }
        .tree li { margin: 0.5em 0; }
        .zone { font-weight: bold; }
        .error { color: red; }
        .chain { font-size: 1.1em; margin-bottom: 1em; }
        footer { margin-top: 2em; font-size: 0.95em; }
        
        /* Custom styling for code blocks */
        pre code {
            border-radius: 6px;
            padding: 16px;
            display: block;
            overflow-x: auto;
        }
        .hljs {
            background: #f6f8fa;
            border: 1px solid #d1d9e0;
        }
    </style>
</head>
<body>
    <header style="display:flex; align-items:center; gap:10px; margin-bottom:1em;">
        <img src="{{ url_for('static', filename='dns_by_eye_200x200.png') }}" alt="DNS By Eye Logo" style="height:40px; width:40px;">
        <h1 style="margin:0;">DNS By Eye</h1>
    </header>
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:1em;">
        <form id="domainForm" style="display:flex; align-items:center; gap:10px; flex-grow:1; max-width: 800px; flex-wrap: wrap;">
        <textarea id="domainInput" placeholder="Enter domain(s) - one per line for comparison (e.g. example.com)" required style="flex-grow:1; min-width: 300px; min-height: 60px; resize: vertical; font-family: monospace;"></textarea>
        <div style="display:flex; flex-direction:column; gap:2px;">
            <label for="dnsServerSelect" style="font-size:0.9em; color:#666;">DNS Server:</label>
            <select id="dnsServerSelect" style="min-width: 150px;">
                <option value="system">System Default</option>
            </select>
        </div>
        <button type="submit">Trace Delegation</button>
        </form>
        <div id="healthScore" style="display:none; align-items:center; gap:5px; padding:5px 10px; border-radius:4px; font-weight:bold;">
            <span class="score">10/10</span>
            <div class="indicator" style="width:20px; height:20px; border-radius:50%;"></div>
            <button class="details" style="background:none; border:1px solid #ccc; padding:2px 6px; border-radius:3px; cursor:pointer; font-size:0.8em;">Details</button>
        </div>
    </div>
    <div id="scoreDetails" style="display:none; margin-bottom:1em; padding:15px; border:1px solid #ddd; border-radius:4px; background:#f8f9fa;">
        <h4 style="margin:0 0 15px 0; text-align:center; font-size:1.2em;">DNS Health Report Card</h4>
        <div id="scoreBreakdown" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
    <div style="display:flex; align-items:center; gap:15px; margin-bottom:1em; flex-wrap: wrap;">
        <label>
            <input type="checkbox" id="verboseCheckbox">
            Verbose output
        </label>
        <label>
            <input type="checkbox" id="debugCheckbox">
            Debug mode
        </label>
        <label>
            <input type="checkbox" id="glueCheckbox" checked>
            Check glue records
        </label>
        <label>
            <input type="checkbox" id="rootFirstCheckbox">
            Display from root servers down
        </label>
        <button type="button" id="shareUrlBtn" style="background:none; border:1px solid #ccc; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.9em;">
            🔗 Share URL
        </button>
    </div>
    <div id="documentation" style="display:none; margin-top:2em; padding:20px; background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px;">
        <h2>API Documentation</h2>
        <p>DNS By Eye provides several REST API endpoints for programmatic access:</p>
        
        <h3>Available Endpoints:</h3>
        
        <h4>1. Full Delegation Analysis</h4>
        <pre><code class="language-http">POST /api/delegation
Content-Type: application/json

{
  "domain": "example.com",
  "verbose": false,
  "dns_server": "system"
}

Returns: Full analysis with graphs and cross-reference data</code></pre>
        
        <h4>2. Simple Trace (No Visualizations)</h4>
        <pre><code class="language-http">GET /api/trace/example.com?verbose=true&dns_server=8.8.8.8

Returns: DNS delegation trace without generating graphs</code></pre>
        
        <h4>3. Get Nameservers</h4>
        <pre><code class="language-http">GET /api/nameservers/example.com?dns_server=1.1.1.1

Returns: List of nameservers for a domain</code></pre>
        
        <h4>4. Available DNS Servers</h4>
        <pre><code class="language-http">GET /api/dns-servers

Returns: List of available public DNS servers</code></pre>
        
        <h4>5. Health Check</h4>
        <pre><code class="language-http">GET /api/health

Returns: Service health status</code></pre>
        
        <h3>DNS Server Options:</h3>
        <ul>
            <li><code>system</code> - Use system default DNS resolver</li>
            <li><code>8.8.8.8</code> - Google DNS</li>
            <li><code>1.1.1.1</code> - Cloudflare DNS</li>
            <li><code>9.9.9.9</code> - Quad9 DNS</li>
            <li><code>208.67.222.222</code> - OpenDNS</li>
        </ul>
        
        <h3>Example Usage:</h3>
        
        <h4>cURL Examples:</h4>
        <pre><code class="language-bash"># Get delegation trace using Cloudflare DNS (local)
curl -X GET "http://localhost:5000/api/trace/google.com?dns_server=1.1.1.1&verbose=true"

# Get delegation trace using live demo instance
curl -X GET "https://tools.apathy.ca/api/trace/google.com?dns_server=1.1.1.1&verbose=true"

# Full analysis with visualizations (local)
curl -X POST "http://localhost:5000/api/delegation" \
     -H "Content-Type: application/json" \
     -d '{"domain": "github.com", "verbose": true, "dns_server": "8.8.8.8"}'

# Full analysis with visualizations (live demo)
curl -X POST "https://tools.apathy.ca/api/delegation" \
     -H "Content-Type: application/json" \
     -d '{"domain": "github.com", "verbose": true, "dns_server": "8.8.8.8"}'</code></pre>
        
        <h4>Python Example:</h4>
        <pre><code class="language-python">import requests
import json

# Base URL for the API (use live demo or local instance)
BASE_URL = "https://tools.apathy.ca"  # Live demo
# BASE_URL = "http://localhost:5000"      # Local instance

def trace_domain(domain, dns_server="system", verbose=False):
    """Get DNS delegation trace for a domain."""
    url = f"{BASE_URL}/api/trace/{domain}"
    params = {
        "dns_server": dns_server,
        "verbose": str(verbose).lower()
    }
    
    response = requests.get(url, params=params)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"Error: {response.status_code} - {response.text}")
        return None

def full_analysis(domain, dns_server="system", verbose=False):
    """Get full delegation analysis with visualizations."""
    url = f"{BASE_URL}/api/delegation"
    data = {
        "domain": domain,
        "dns_server": dns_server,
        "verbose": verbose
    }
    
    response = requests.post(url, json=data)
    if response.status_code == 200:
        return response.json()
    else:
        print(f"Error: {response.status_code} - {response.text}")
        return None

# Example usage
if __name__ == "__main__":
    domain = "example.com"
    
    # Simple trace
    print("=== DNS Trace ===")
    trace_data = trace_domain(domain, dns_server="8.8.8.8", verbose=True)
    if trace_data:
        for step in trace_data["trace"]:
            print(f"{step['zone']}: {', '.join(step['nameservers'])}")
    
    # Full analysis
    print("\n=== Full Analysis ===")
    analysis = full_analysis(domain, dns_server="1.1.1.1", verbose=True)
    if analysis:
        print(f"Chain: {analysis['chain']}")
        print(f"Cross-reference results: {len(analysis.get('cross_ref_results', {}))}")
        print(f"Graph URLs: {len(analysis.get('graph_urls', []))}")
</code></pre>
        
        <h3>Rate Limiting:</h3>
        <p>All endpoints are rate-limited. Default limit is 100 requests per day.</p>
    </div>

    <div id="chain" class="chain"></div>
    <div id="tree" class="tree"></div>
    <div id="graphviz" style="margin-top:2em;"></div>
    
    <!-- Export buttons moved to bottom -->
    <div id="exportButtons" style="display:none; margin-top:2em; margin-bottom:1em; gap:10px;">
        <h3>Export Results</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" id="exportJsonBtn" style="background:#007bff; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">
                📄 Export JSON
            </button>
            <button type="button" id="exportCsvBtn" style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;">
                📊 Export CSV
            </button>
        </div>
    </div>
    
    <hr style="margin-top: 2em; margin-bottom: 1em;">
    
    <!-- Documentation moved to bottom -->
    <div style="margin-bottom: 1em; display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
        <button type="button" id="docsToggle" style="background:none; border:1px solid #ccc; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:0.9em;">
            📖 API Documentation
        </button>
        <div style="padding: 8px 16px; border: 1px solid #28a745; border-radius: 4px; background: #f8f9fa; font-size: 0.9em;">
            🔧 <strong>Test Domain:</strong> <code>test.apathy.ca</code> - 
            <a href="#" id="testDomainLink" style="color: #007bff; text-decoration: none;">Try broken DNS example</a> | 
            <a href="https://github.com/apathy-ca/dns_by_eye/tree/main/dns-examples" target="_blank" style="color: #007bff; text-decoration: none;">Setup Guide</a>
        </div>
    </div>
    
    <footer>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: center; text-align: center;">
            <span>DNS By Eye v1.0.2</span>
            <span>|</span>
            <span>Inspired by <a href="https://www.zonecut.net/dns/" target="_blank">dnsbajaj</a></span>
            <span>|</span>
            <span>Created by ChatGPT, Cline & Anthropic (Claude Sonnet)</span>
            <span>|</span>
            <span><a href="https://tools.apathy.ca" target="_blank">🌐 Live Demo</a></span>
            <span>|</span>
            <span><a href="https://github.com/apathy-ca/dns_by_eye" target="_blank">📂 GitHub Repository</a></span>
        </div>
    </footer>
    <script>
        // Load DNS servers on page load
        async function loadDnsServers() {
            try {
                const resp = await fetch('/api/dns-servers');
                const servers = await resp.json();
                const select = document.getElementById('dnsServerSelect');
                
                // Clear existing options except system default
                select.innerHTML = '<option value="system">System Default</option>';
                
                // Add other servers
                for (const [value, label] of Object.entries(servers)) {
                    if (value !== 'system') {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = label;
                        select.appendChild(option);
                    }
                }
            } catch (err) {
                console.error('Failed to load DNS servers:', err);
            }
        }

        // Use health score from API response instead of calculating separately
        function getHealthScoreFromResponse(data) {
            // Use the health_score from the API response directly
            if (data.health_score) {
                return {
                    score: data.health_score.score,
                    maxScore: data.health_score.max_score,
                    breakdown: data.health_score.breakdown
                };
            }
            
            // Fallback if no health_score in response
            return {
                score: 0,
                maxScore: 10,
                breakdown: ['No health score data available']
            };
        }

        // Update health score display
        function updateHealthScore(data) {
            const healthScore = document.getElementById('healthScore');
            const scoreSpan = healthScore.querySelector('.score');
            const indicator = healthScore.querySelector('.indicator');
            const details = healthScore.querySelector('.details');
            const scoreDetails = document.getElementById('scoreDetails');
            const scoreBreakdown = document.getElementById('scoreBreakdown');
            
                const { score, maxScore, breakdown } = getHealthScoreFromResponse(data);
            
            // Update score and color
            scoreSpan.textContent = `${score}/${maxScore}`;
            
            let color;
            const percentage = (score / maxScore) * 100;
            if (percentage >= 90) {
                color = '#28a745';  // Green
            } else if (percentage >= 70) {
                color = '#ffc107';  // Yellow
            } else {
                color = '#dc3545';  // Red
            }
            
            indicator.style.backgroundColor = color;
            healthScore.style.display = 'flex';
            
            // Update breakdown with report card style
            const items = breakdown.map(item => {
                let icon, color;
                if (item.includes('has errors') || item.includes('has slow response') || 
                    item.includes('issue') || item.includes('inconsistent') || 
                    item.startsWith('-')) {
                    icon = '❌';
                    color = '#dc3545';
                } else {
                    icon = '✅';
                    color = '#28a745';
                }
                
                return `<div style="padding:10px; border-radius:4px; background:${color}15; border-left:4px solid ${color}; display:flex; align-items:center;">
                    <span style="margin-right:10px; font-size:1.2em;">${icon}</span>
                    <span>${item}</span>
                </div>`;
            });
            scoreBreakdown.innerHTML = items.join('');
            
            // Show/hide details
            details.onclick = () => {
                scoreDetails.style.display = scoreDetails.style.display === 'none' ? 'block' : 'none';
            };
        }

        // Current query data for export
        let currentQueryData = null;

        function renderTree(trace, verbose, rootFirst = false) {
            if (!trace.length) return '';
            let html = '<ul>';
            
            // Create array of indices to iterate over
            let indices = [];
            for (let i = 0; i < trace.length; i++) {
                // Hide TLD layers (0 and 1) unless verbose is true
                if (!verbose && (i === 0 || i === 1)) {
                    continue;
                }
                indices.push(i);
            }
            
            // Reverse the order unless rootFirst is true
            if (!rootFirst) {
                indices.reverse();
            }
            
            for (const i of indices) {
                const node = trace[i];
                html += '<li>';
                html += `<span class="zone">${node.zone}</span>: `;
                if (node.nameservers.length && node.nameservers[0].startsWith("Error:")) {
                    html += `<span class="error">${node.nameservers[0]}</span>`;
                } else {
                    html += node.nameservers.join(', ');
                }
                // Show response time with slow indicator
                if (node.response_time !== undefined) {
                    const timeClass = node.is_slow ? 'error' : '';
                    const slowFlag = node.is_slow ? ' ⚠️ SLOW' : '';
                    html += ` <small class="${timeClass}">(${node.response_time}ms${slowFlag})</small>`;
                }
                html += '</li>';
            }
            html += '</ul>';
            return html;
        }

        function renderComparisonTree(comparisonResults) {
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';
            
            for (const [domain, result] of Object.entries(comparisonResults)) {
                html += `<div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                            <h3>${domain}</h3>
                            <p><strong>Chain:</strong> ${result.chain}</p>
                            <p><strong>Total Response Time:</strong> ${result.total_response_time}ms</p>
                            <p><strong>Slow Responses:</strong> ${result.slow_responses}</p>
                            <p><strong>Nameserver Count:</strong> ${result.nameserver_count}</p>
                            <div style="max-height: 200px; overflow-y: auto;">`;
                
                result.trace.forEach(node => {
                    html += `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa; border-radius: 4px;">
                                <strong>${node.zone}:</strong> ${node.nameservers.join(', ')}`;
                    if (node.response_time !== undefined) {
                        const timeClass = node.is_slow ? 'color: red;' : '';
                        const slowFlag = node.is_slow ? ' ⚠️' : '';
                        html += ` <small style="${timeClass}">(${node.response_time}ms${slowFlag})</small>`;
                    }
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            }
            
            html += '</div>';
            return html;
        }

        function updateUrlParams(domains, verbose, dns_server, debug) {
            const url = new URL(window.location);
            url.searchParams.set('domains', domains.join(','));
            url.searchParams.set('verbose', verbose);
            url.searchParams.set('dns_server', dns_server);
            url.searchParams.set('debug', debug);
            window.history.replaceState({}, '', url);
        }

        function loadFromUrlParams() {
            const url = new URL(window.location);
            const domainsParam = url.searchParams.get('domains');
            const verbose = url.searchParams.get('verbose') === 'true';
            const dns_server = url.searchParams.get('dns_server') || 'system';
            const debug = url.searchParams.get('debug') === 'true';
            
            if (domainsParam) {
                document.getElementById('domainInput').value = domainsParam.replace(/,/g, '\n');
                document.getElementById('verboseCheckbox').checked = verbose;
                document.getElementById('debugCheckbox').checked = debug;
                document.getElementById('dnsServerSelect').value = dns_server;
                
                // Auto-submit if domains are in URL
                document.getElementById('domainForm').dispatchEvent(new Event('submit'));
            }
        }

        function renderGlueRecords(glueResults, check_glue) {
            let html = `<div style="display: ${check_glue ? 'block' : 'none'}; margin-top:2em; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                           <details>
                               <summary style="cursor: pointer; font-weight: bold; color: #666;">🔗 Glue Record Analysis</summary>
                               <div style="margin-top: 15px;">`;
            
            // Summary statistics
            const totalZones = Object.keys(glueResults).length;
            const zonesWithIssues = Object.values(glueResults).filter(zone => zone.glue_issues && zone.glue_issues.length > 0).length;
            const totalNameservers = Object.values(glueResults).reduce((sum, zone) => sum + zone.nameservers.length, 0);
            const nameserversWithIssues = Object.values(glueResults).reduce((sum, zone) => {
                return sum + Object.values(zone.glue_records || {}).filter(ns => ns.issues && ns.issues.length > 0).length;
            }, 0);
            
            html += `<div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0;">Summary</h4>
                        <p style="margin: 5px 0;"><strong>Total Zones:</strong> ${totalZones}</p>
                        <p style="margin: 5px 0;"><strong>Zones with Issues:</strong> ${zonesWithIssues}</p>
                        <p style="margin: 5px 0;"><strong>Total Nameservers:</strong> ${totalNameservers}</p>
                        <p style="margin: 5px 0;"><strong>Nameservers with Issues:</strong> ${nameserversWithIssues}</p>
                     </div>`;
            
            // Detailed results for each zone
            for (const [zone, zoneData] of Object.entries(glueResults)) {
                if (zoneData.status === 'success' && zoneData.nameservers.length > 0) {
                    const hasIssues = zoneData.glue_issues && zoneData.glue_issues.length > 0;
                    // Determine if there are any serious issues vs warnings
                    const hasErrors = zoneData.glue_issues && zoneData.glue_issues.some(issue => 
                        issue.includes('Missing glue') || issue.includes("don't match")
                    );
                    
                    let borderColor, bgColor, textColor;
                    if (hasErrors) {
                        // Red for serious problems
                        borderColor = '#dc3545';
                        bgColor = '#f8d7da';
                        textColor = '#721c24';
                    } else if (hasIssues) {
                        // Yellow for warnings
                        borderColor = '#ffc107';
                        bgColor = '#fff3cd';
                        textColor = '#856404';
                    } else {
                        // Green for good
                        borderColor = '#28a745';
                        bgColor = '#d4edda';
                        textColor = '#155724';
                    }
                    
                    html += `<div style="border: 1px solid ${borderColor}; border-radius: 4px; margin: 10px 0; background: ${bgColor};">
                                <div style="padding: 10px; border-bottom: 1px solid ${borderColor};">
                                    <h4 style="margin: 0; color: ${textColor};">
                                        ${zone === '.' ? 'Root Zone (.)' : zone}
                                        ${hasErrors ? ' ❌' : hasIssues ? ' ⚠️' : ' ✅'}
                                    </h4>
                                </div>
                                <div style="padding: 10px;">`;
                    
                    // Zone-level issues
                    if (zoneData.glue_issues && zoneData.glue_issues.length > 0) {
                        html += `<div style="margin-bottom: 10px;">
                                    <strong style="color: #721c24;">Zone Issues:</strong>
                                    <ul style="margin: 5px 0; padding-left: 20px;">`;
                        zoneData.glue_issues.forEach(issue => {
                            html += `<li style="color: #721c24;">${issue}</li>`;
                        });
                        html += `</ul></div>`;
                    }
                    
                    // Nameserver details
                    if (zoneData.glue_records && Object.keys(zoneData.glue_records).length > 0) {
                        html += `<div><strong>Nameserver Details:</strong></div>`;
                        for (const [ns, nsData] of Object.entries(zoneData.glue_records)) {
                            const nsHasIssues = nsData.issues && nsData.issues.length > 0;
                            const nsColor = nsHasIssues ? '#721c24' : '#155724';
                            
                            html += `<div style="margin: 10px 0; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; background: white;">
                                        <div style="font-weight: bold; color: ${nsColor};">
                                            ${ns} ${nsHasIssues ? '⚠️' : '✅'}
                                        </div>
                                        <div style="margin-top: 5px; font-size: 0.9em;">`;
                            
                            // Expected glue status
                            html += `<div><strong>Expected Glue:</strong> ${nsData.expected_glue ? 'Yes (in-zone nameserver)' : 'No (out-of-zone nameserver)'}</div>`;
                            
                            // Parent zone glue record status
                            const parentZone = zone === '.' ? 'Root Servers' : 
                                             zone.includes('.') ? zone.substring(zone.indexOf('.') + 1) : 'TLD';
                            html += `<div style="margin-top:8px;"><strong>Glue Records from Parent Zone (${parentZone}):</strong></div>`;
                            html += `<div style="margin-left:15px;">
                                <div><strong>Has A Record:</strong> ${nsData.has_glue_a ? 'Yes' : 'No'}</div>
                                <div><strong>Has AAAA Record:</strong> ${nsData.has_glue_aaaa ? 'Yes' : 'No'}</div>
                            </div>`;
                            
                            // Show records comparison in a table
                            html += `<div style="margin-top:8px;"><strong>Records Comparison:</strong></div>`;
                            html += `<table style="margin-left:15px; border-collapse:collapse; width:calc(100% - 15px);">
                                <tr style="background:#f8f9fa;">
                                    <th style="text-align:left; padding:4px;">Record Type</th>
                                    <th style="text-align:left; padding:4px;">Parent Zone (${parentZone}) Glue</th>
                                    <th style="text-align:left; padding:4px;">Actual Resolution</th>
                                </tr>`;
                            
                            // A Records
                            html += `<tr>
                                <td style="padding:4px;"><strong>A</strong></td>
                                <td style="padding:4px;">${nsData.glue_a_records?.join(', ') || 'None'}</td>
                                <td style="padding:4px;">${nsData.resolved_a_records?.join(', ') || 'None'}</td>
                            </tr>`;
                            
                            // AAAA Records
                            html += `<tr>
                                <td style="padding:4px;"><strong>AAAA</strong></td>
                                <td style="padding:4px;">${nsData.glue_aaaa_records?.join(', ') || 'None'}</td>
                                <td style="padding:4px;">${nsData.resolved_aaaa_records?.join(', ') || 'None'}</td>
                            </tr>
                            </table>`;
                            
                            // Show match status
                            html += `<div><strong>Glue Matches Resolution:</strong> ${nsData.glue_matches_resolution ? 'Yes' : 'No'}</div>`;
                            
                            // Show issues if any
                            if (nsData.issues && nsData.issues.length > 0) {
                                html += `<div style="margin-top: 5px;"><strong style="color: #721c24;">Issues:</strong>
                                            <ul style="margin: 5px 0; padding-left: 20px;">`;
                                nsData.issues.forEach(issue => {
                                    html += `<li style="color: #721c24;">${issue}</li>`;
                                });
                                html += `</ul></div>`;
                            }
                            
                            html += `</div></div>`;
                        }
                    }
                    
                    html += `</div></div>`;
                }
            }
            
            html += `</div></details></div>`;
            return html;
        }

        document.getElementById('domainForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const domainInput = document.getElementById('domainInput').value.trim();
            const domains = domainInput.split('\n').map(d => d.trim()).filter(d => d);
            const verbose = document.getElementById('verboseCheckbox').checked;
            const debug = document.getElementById('debugCheckbox').checked;
            const check_glue = document.getElementById('glueCheckbox').checked;
            const dns_server = document.getElementById('dnsServerSelect').value;
            
            if (domains.length === 0) {
                alert('Please enter at least one domain');
                return;
            }
            
            document.getElementById('chain').innerHTML = '';
            document.getElementById('tree').innerHTML = 'Loading...';
            document.getElementById('graphviz').innerHTML = '';
            document.getElementById('exportButtons').style.display = 'none';
            document.getElementById('healthScore').style.display = 'none';
            document.getElementById('scoreDetails').style.display = 'none';
            
            // Update URL for bookmarking
            updateUrlParams(domains, verbose, dns_server, debug);
            
            let resp, data;
            
            if (domains.length === 1) {
                // Single domain analysis
                try {
                    resp = await fetch('/api/delegation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ domain: domains[0], verbose, dns_server, check_glue })
                    });
                    data = await resp.json();
                } catch (err) {
                    document.getElementById('chain').innerHTML = `<span class="error">Network error: ${err.message}</span>`;
                    document.getElementById('tree').innerHTML = '';
                    document.getElementById('graphviz').innerHTML = '';
                    return;
                }
                
                if (!resp.ok || data.error) {
                    const msg = data.error || `HTTP error: ${resp.status}`;
                    document.getElementById('chain').innerHTML = `<span class="error">${msg}</span>`;
                    document.getElementById('tree').innerHTML = '';
                    document.getElementById('graphviz').innerHTML = '';
                    return;
                }
                
                currentQueryData = { domain: domains[0], verbose, dns_server, debug };
                document.getElementById('chain').innerHTML = data.chain ? `<b>Chain:</b> ${data.chain}` : '';
                updateHealthScore(data);
                const rootFirst = document.getElementById('rootFirstCheckbox').checked;
                document.getElementById('tree').innerHTML = renderTree(data.trace, verbose, rootFirst);
                document.getElementById('exportButtons').style.display = 'flex';
                
                if (data.graph_urls && data.graph_urls.length) {
                    let html = '';
                    const rootFirst = document.getElementById('rootFirstCheckbox').checked;
                    
                    // Show Domain Report first
                    if (data.domain_report_graph_url) {
                        html += `<div style="margin-bottom:2em; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                    <h3>Domain Report</h3>
                                    <img src="${data.domain_report_graph_url}" alt="Domain Report Graph" style="max-width:100%; height: auto;"/>
                                 </div>`;
                    }
                    
                    // Show glue records analysis
                    if (data.glue_results && Object.keys(data.glue_results).length > 0) {
                        html += renderGlueRecords(data.glue_results, check_glue);
                    }
                    
                    // Create array of indices for graph display order
                    let graphIndices = [];
                    for (let i = 0; i < data.graph_urls.length; i++) {
                        graphIndices.push(i);
                    }
                    
                    // Reverse the order unless rootFirst is true
                    if (!rootFirst) {
                        graphIndices.reverse();
                    }
                    
                    // Show delegation graphs
                    graphIndices.forEach((idx) => {
                        const url = data.graph_urls[idx];
                        const layerName = data.trace && data.trace[idx] ? data.trace[idx].zone : `Layer ${idx + 1}`;
                        const isRoot = layerName === '.';
                        
                        html += `<div style="margin-bottom: 2em; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                    <h3>${isRoot ? 'Root Servers (.)' : layerName}</h3>
                                    <div style="text-align: center;">
                                        <img src="${url}" alt="DNS Delegation Graph ${layerName}" style="max-width:100%; height: auto;">
                                    </div>`;
                        
                        // Add verbose info section (hidden by default, controlled by checkbox)
                        if (data.trace && data.trace[idx] && data.trace[idx].verbose) {
                            html += `<div class="verbose-section" style="display: ${verbose ? 'block' : 'none'}; margin-top: 15px;">
                                        <details>
                                            <summary style="cursor: pointer; font-weight: bold; color: #666;">Technical Details</summary>
                                            <pre style="background:#f0f0f0; padding:10px; white-space: pre-wrap; margin-top: 10px; border-radius: 4px;">${data.trace[idx].verbose}</pre>
                                        </details>
                                     </div>`;
                        }
                        html += `</div>`;
                    });
                    
                    // Show domain analysis results (formerly cross-reference results)
                    if (data.cross_ref_results && Object.keys(data.cross_ref_results).length > 0) {
                        html += `<div style="margin-top:2em; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                    <h3 style="margin-top:0;">Domain Analysis</h3>
                                    <ul style="text-align: left; margin-top: 10px; padding-left: 20px;">`;
                        for (const [ns, info] of Object.entries(data.cross_ref_results)) {
                            let refs = info.references || [];
                            let aRecords = info.A || [];
                            let aaaaRecords = info.AAAA || [];
                            let glueInfo = data.glue_results && data.glue_results[data.trace[data.trace.length - 1].zone]?.glue_records[ns];
                            
                            html += `<li style="margin: 10px 0;">
                                     <h4 style="margin:5px 0;">${ns}</h4>
                                     <div style="margin-left: 15px;">
                                         <strong>References:</strong> ${Array.isArray(refs) ? refs.join(', ') : refs}<br>
                                         <strong>A Records:</strong> ${aRecords.join(', ') || 'None'}<br>
                                         <strong>AAAA Records:</strong> ${aaaaRecords.join(', ') || 'None'}<br>`;
                            
                            if (glueInfo) {
                                html += `<strong>Glue Record Status:</strong> `;
                                if (glueInfo.issues && glueInfo.issues.length > 0) {
                                    html += `<span style="color: #dc3545;">❌ Issues Found</span><br>`;
                                    html += `<ul style="margin-top: 5px;">`;
                                    glueInfo.issues.forEach(issue => {
                                        html += `<li style="color: #dc3545;">${issue}</li>`;
                                    });
                                    html += `</ul>`;
                                } else {
                                    html += `<span style="color: #28a745;">✅ No Issues</span>`;
                                }
                            }
                            
                            html += `</div></li>`;
                        }
                        html += `</ul></div>`;
                    }
                    
                    // Show glue record results if any
                    if (data.glue_results && Object.keys(data.glue_results).length > 0) {
                        html += renderGlueRecords(data.glue_results, check_glue);
                    }
                    
                    document.getElementById('graphviz').innerHTML = html;
                }
            } else {
                // Multi-domain comparison
                try {
                    resp = await fetch('/api/compare', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ domains, verbose, dns_server, debug })
                    });
                    data = await resp.json();
                } catch (err) {
                    document.getElementById('chain').innerHTML = `<span class="error">Network error: ${err.message}</span>`;
                    document.getElementById('tree').innerHTML = '';
                    document.getElementById('graphviz').innerHTML = '';
                    return;
                }
                
                if (!resp.ok || data.error) {
                    const msg = data.error || `HTTP error: ${resp.status}`;
                    document.getElementById('chain').innerHTML = `<span class="error">${msg}</span>`;
                    document.getElementById('tree').innerHTML = '';
                    document.getElementById('graphviz').innerHTML = '';
                    return;
                }
                
                currentQueryData = { domains, verbose, dns_server, debug, comparison: true };
                document.getElementById('chain').innerHTML = `<b>Domain Comparison:</b> ${domains.length} domains analyzed`;
                document.getElementById('tree').innerHTML = renderComparisonTree(data.comparison_results);
                document.getElementById('exportButtons').style.display = 'flex';
                document.getElementById('graphviz').innerHTML = '';
                document.getElementById('healthScore').style.display = 'none';
                document.getElementById('scoreDetails').style.display = 'none';
            }
        });

        // Add event listener to toggle verbose sections when checkbox changes
        document.getElementById('verboseCheckbox').addEventListener('change', function() {
            const verboseSections = document.querySelectorAll('.verbose-section');
            const isChecked = this.checked;
            verboseSections.forEach(section => {
                section.style.display = isChecked ? 'block' : 'none';
            });
        });

        // Add event listener to re-render tree and graphs when root-first checkbox changes
        document.getElementById('rootFirstCheckbox').addEventListener('change', function() {
            if (currentQueryData && currentQueryData.domain && window.lastTraceData && window.lastGraphData) {
                const verbose = document.getElementById('verboseCheckbox').checked;
                const rootFirst = this.checked;
                
                // Re-render tree
                document.getElementById('tree').innerHTML = renderTree(window.lastTraceData, verbose, rootFirst);
                
                // Re-render graphs
                if (window.lastGraphData.graph_urls && window.lastGraphData.graph_urls.length) {
                    let html = '';
                    
                    // Create array of indices for graph display order
                    let graphIndices = [];
                    for (let i = 0; i < window.lastGraphData.graph_urls.length; i++) {
                        graphIndices.push(i);
                    }
                    
                    // Reverse the order unless rootFirst is true
                    if (!rootFirst) {
                        graphIndices.reverse();
                    }
                    
                    graphIndices.forEach((idx) => {
                        const url = window.lastGraphData.graph_urls[idx];
                        const layerName = window.lastGraphData.trace && window.lastGraphData.trace[idx] ? window.lastGraphData.trace[idx].zone : `Layer ${idx + 1}`;
                        const isRoot = layerName === '.';
                        
                        html += `<div style="margin-bottom: 2em; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                    <h3>${isRoot ? 'Root Servers (.)' : layerName}</h3>
                                    <div style="text-align: center;">
                                        <img src="${url}" alt="DNS Delegation Graph ${layerName}" style="max-width:100%; height: auto;">
                                    </div>`;
                        
                        // Add verbose info section (hidden by default, controlled by checkbox)
                        if (window.lastGraphData.trace && window.lastGraphData.trace[idx] && window.lastGraphData.trace[idx].verbose) {
                            html += `<div class="verbose-section" style="display: ${verbose ? 'block' : 'none'}; margin-top: 15px;">
                                        <details>
                                            <summary style="cursor: pointer; font-weight: bold; color: #666;">Technical Details</summary>
                                            <pre style="background:#f0f0f0; padding:10px; white-space: pre-wrap; margin-top: 10px; border-radius: 4px;">${window.lastGraphData.trace[idx].verbose}</pre>
                                        </details>
                                     </div>`;
                        }
                        html += `</div>`;
                    });
                    
                    // Always append Domain Report graph if available
                    if (window.lastGraphData.domain_report_graph_url) {
                        html += `<div style="margin-top:2em; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                    <h3>Domain Report</h3>
                                    <img src="${window.lastGraphData.domain_report_graph_url}" alt="Domain Report Graph" style="max-width:100%; height: auto;"/>
                                 </div>`;
                    }
                    
                    // Show cross reference results if any (below the graph)
                    if (window.lastGraphData.cross_ref_results && Object.keys(window.lastGraphData.cross_ref_results).length > 0) {
                        html += `<div class="verbose-section" style="display: ${verbose ? 'block' : 'none'}; margin-top:2em; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                    <details>
                                        <summary style="cursor: pointer; font-weight: bold; color: #666;">Last Level Nameserver Cross-Reference Results</summary>
                                        <ul style="text-align: left; margin-top: 10px;">`;
                        for (const [ns, info] of Object.entries(window.lastGraphData.cross_ref_results)) {
                            let refs = info.references || [];
                            let aRecords = info.A || [];
                            let aaaaRecords = info.AAAA || [];
                            html += `<li style="margin: 10px 0;"><b>${ns}</b>:<br>
                                     <span style="margin-left: 15px;">References: ${Array.isArray(refs) ? refs.join(', ') : refs}</span><br>
                                     <span style="margin-left: 15px;">A: ${aRecords.join(', ')}</span><br>
                                     <span style="margin-left: 15px;">AAAA: ${aaaaRecords.join(', ')}</span></li>`;
                        }
                        html += `</ul></details></div>`;
                    }
                    
                    // Show glue record results if any
                    if (window.lastGraphData.glue_results && Object.keys(window.lastGraphData.glue_results).length > 0) {
                        const check_glue = document.getElementById('glueCheckbox').checked;
                        html += renderGlueRecords(window.lastGraphData.glue_results, check_glue);
                    }
                    
                    document.getElementById('graphviz').innerHTML = html;
                }
            }
        });

        // Toggle documentation visibility
        document.getElementById('docsToggle').addEventListener('click', function() {
            const docs = document.getElementById('documentation');
            const isVisible = docs.style.display !== 'none';
            docs.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? '📖 API Documentation' : '❌ Hide Documentation';
            
            // Apply syntax highlighting when documentation is shown
            if (!isVisible) {
                setTimeout(() => {
                    if (window.hljs) {
                        document.querySelectorAll('#documentation pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }, 50);
            }
        });

        // Share URL functionality
        document.getElementById('shareUrlBtn').addEventListener('click', function() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const btn = this;
                const originalText = btn.textContent;
                btn.textContent = '✓ Copied!';
                btn.style.background = '#28a745';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = 'none';
                    btn.style.color = 'inherit';
                }, 2000);
            }).catch(() => {
                alert('Unable to copy URL to clipboard');
            });
        });

        // Export functionality
        document.getElementById('exportJsonBtn').addEventListener('click', function() {
            if (!currentQueryData) {
                alert('No data to export. Please run a query first.');
                return;
            }
            
            if (currentQueryData.comparison) {
                // For comparison, export as JSON isn't supported via single endpoint
                alert('JSON export for comparison not yet implemented. Use individual domain exports.');
                return;
            }
            
            const params = new URLSearchParams({
                format: 'json',
                verbose: currentQueryData.verbose,
                dns_server: currentQueryData.dns_server,
                debug: currentQueryData.debug
            });
            
            window.open(`/api/export/${currentQueryData.domain}?${params}`, '_blank');
        });

        document.getElementById('exportCsvBtn').addEventListener('click', function() {
            if (!currentQueryData) {
                alert('No data to export. Please run a query first.');
                return;
            }
            
            if (currentQueryData.comparison) {
                alert('CSV export for comparison not yet implemented. Use individual domain exports.');
                return;
            }
            
            const params = new URLSearchParams({
                format: 'csv',
                verbose: currentQueryData.verbose,
                dns_server: currentQueryData.dns_server,
                debug: currentQueryData.debug
            });
            
            window.open(`/api/export/${currentQueryData.domain}?${params}`, '_blank');
        });

        // Add copy-to-clipboard functionality for code examples
        function addCopyButtons() {
            const codeBlocks = document.querySelectorAll('#documentation pre code');
            codeBlocks.forEach((codeBlock, index) => {
                const pre = codeBlock.parentElement;
                if (pre.querySelector('.copy-btn')) return; // Already has copy button
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = '📋 Copy';
                copyBtn.style.cssText = `
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: #007bff;
                    color: white;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 0.8em;
                    z-index: 10;
                `;
                
                pre.style.position = 'relative';
                pre.appendChild(copyBtn);
                
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
                        copyBtn.textContent = '✓ Copied';
                        copyBtn.style.background = '#28a745';
                        setTimeout(() => {
                            copyBtn.textContent = '📋 Copy';
                            copyBtn.style.background = '#007bff';
                        }, 2000);
                    }).catch(() => {
                        alert('Unable to copy to clipboard');
                    });
                });
            });
        }

        // Enhanced documentation toggle with copy buttons
        document.getElementById('docsToggle').addEventListener('click', function() {
            const docs = document.getElementById('documentation');
            const isVisible = docs.style.display !== 'none';
            docs.style.display = isVisible ? 'none' : 'block';
            this.textContent = isVisible ? '📖 API Documentation' : '❌ Hide Documentation';
            
            // Apply syntax highlighting when documentation is shown
            if (!isVisible) {
                setTimeout(() => {
                    if (window.hljs) {
                        document.querySelectorAll('#documentation pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                    addCopyButtons();
                }, 50);
            }
        });

        // Add Enter key functionality to textarea
        document.getElementById('domainInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Trigger the form submit button click instead of dispatching event
                document.querySelector('#domainForm button[type="submit"]').click();
            }
        });

        // Test domain link functionality
        document.getElementById('testDomainLink').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('domainInput').value = 'test.apathy.ca';
            document.getElementById('verboseCheckbox').checked = true;
            document.getElementById('dnsServerSelect').value = 'system';
            // Trigger the form submit button click instead of dispatching event
            document.querySelector('#domainForm button[type="submit"]').click();
        });

        // Load DNS servers when page loads
        loadDnsServers();
        
        // Load from URL parameters on page load
        window.addEventListener('load', loadFromUrlParams);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Initialize highlight.js when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (window.hljs) {
                hljs.highlightAll();
            }
        });
    </script>
</body>
</html>
